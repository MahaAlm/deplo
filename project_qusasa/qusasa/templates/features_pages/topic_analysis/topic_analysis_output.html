{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qusasa | YouTube Topic Analysis</title>
    <!-- Linking CSS -->
    <link rel="stylesheet" href="{% static 'qusasa/css/signup.css' %}" />
    <link rel="stylesheet" href="{% static 'qusasa/css/base.css' %}" />
    <link rel="stylesheet" href="{% static 'qusasa/css/cards.css' %}" />
    <link rel="stylesheet" href="{% static 'qusasa/css/feature_details.css' %}" />
    <link rel="stylesheet" href="{% static 'qusasa/css/output.css' %}" />
    <link href="https://cdn.rawgit.com/michalsnik/aos/2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.rawgit.com/michalsnik/aos/2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- Make sure to include the cloud layout plugin after the main D3 library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Include Owl Carousel CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">

    <!-- Include jQuery Library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include Owl Carousel JS File -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>

    <script src="https://kit.fontawesome.com/b50b47369c.js" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="{% static 'qusasa/images/Qusasa end.png' %}" type="image/png">


  </head>
  <style>
    .body1 {
      font-family: 'Arial', sans-serif;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      padding: 20px;
      margin: 0;
      align-items: stretch;
    }
    .thumbnail iframe {
    width: 100%; 
    height: auto; 
    border-radius: 10px; 
  }

  .stat {
    margin: 0 1rem;
  }
    .card {
      background: #805ea976;
      border-radius: 30px;
      padding: 15px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid #7587ff;
      box-shadow: 0 0 30px 10px #6b4e8f76;
      height: auto;
      align-items: stretch;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    
    .card-header {
      font-weight: 600;
      font-size: 25px;
      text-align: center;
      margin-bottom: 10px;
    }
    .thumbnail {
      background-color: #706fd3;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 14px;
    }
    .statistics {
  display: flex;
  justify-content: space-around; /* Adjust as necessary to space items */
  margin-top: 10px;
}

.stat {
  display: flex;
  flex-direction: column; /* Stack number and label vertically */
  align-items: center; /* Center-align the flex items */
}

.number {
    font-weight: 500;
  font-size: 30px; 
  color: #fff; /* White text color */
}

.label {
  font-size: 20px; /* Smaller font size for the label */
  color: #fff; /* White text color */
}

    .sentiment {
      height: 10px;
      background: #ff5252;
      width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    
    /* Sizes for the cards based on the image */
   
    .medium-card { width: 320px; height: 300px; }
    .dashboard-container {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Two columns of equal size */
  grid-gap: 20px; /* Gap between grid items */
  padding: 20px;
}

/* Optional: if you want to make the line chart bigger than the radial chart */
#lineChart { 
  grid-column: span 2; /* Line chart will span across two columns */
}

#positiveCommentsChart { 
  /* Ensures the radial bar chart takes up the space of one column */
  max-width: 100%; /* Optional: You can adjust this value if the chart appears too big */
}


.chart {
  
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.medium-card {
    height: auto;
}

  </style>
  <body>
    
    <a class="log-out" href="#popup1"><i class="fa-solid fa-right-from-bracket"></i> Exit Analysis</a>

    
    <div class="output-container">

        <div class="mini-container">
            <div class="output-header " data-aos="fade-up">
                <h1>Your topic analysis is ready!</h1>
                <p>Check out the metrics and insights to dive into the trends and discussions around your chosen subject.</p>
            </div>
        </div>
        
        <div class="mini-container">
            <h2 data-aos="fade-up">Download your results:</h2>
        <div class="downlaodables" data-aos="fade-up">
            <div class="download-dataset download-el">
                <i class="fa-solid fa-table"></i>
                <div class="download-text">
                    <div class="text">
                        <h3>{{type}} Datasets</h3>
                    <p>Have a list of all videos, channels, and comments related to your topic </p>
                    </div>
                    
                    <div class="button">
                        <button id="download-dataset-button">Download the dataset</button>
                    </div>
                    
                </div>

            </div>
            <div class="download-report download-el">
                <i class="fa-solid fa-file-contract"></i>
                <div class="download-text ">
                    <div class="text">
                        <h3>Analysis report</h3>
                        <p>including all the graphs, statistics, and interpretaions presented.</p>
                    </div>
                    
                      <div class="button">
                        <a href="{% url 'download_docx' filename=docx_file %}"><button>Download the report</button></a>
                      </div>
                    
                </div>
            </div>
        </div>

        </div>
        

        <div class="mini-container">
            <div class="output-header " data-aos="fade-up">
                <h1>
                    Take a look at the top 5 trending videos on your topic</h1>
                <p>Reflecting the latest insights and popular discussions</p>
                <div class="body1">

                    {% for video in top_5_videos %}
                    <div class="card medium-card">
                      <div class="card-header">{{video.title}}</div>
                      <div class="thumbnail"> <iframe width="560" height="315" src="https://www.youtube.com/embed/{{video.videoId}}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
                      <div class="statistics">
                        <div class="stat">
                            <div class="number">{{video.likesCount}}</div>
                            <div class="label">Likes</div>
                          </div>
                          <div class="stat">
                            <div class="number">{{video.viewsCount}}</div>
                            <div class="label">Views</div>
                          </div>
                      </div>
                      <div id="positive-comments-gauge" class="chart-container"></div>
                    </div>
                    {%endfor%}
                    
                </div>
            </div>
        </div>
        <h1 data-aos="fade-up">Topic Analytics</h1>
        <p data-aos="fade-up"> Enhance your understanding with our topic analysis.</p>
       
      

        <div class="mini-container stats-graphs-container" data-aos="fade-up">
            
            <div class="stats-graphs" data-aos="fade-up">
                <div class="dashboard-container">
                  <div class="chart">
                    <p>Video Views Distribution by Channel</p><h5>A pie chart highlighting the most active channels and comparing their views average</h5>
                    <div id="pieChart" class="chart" style="box-shadow: none;"></div>

                  </div>
                    <div class="chart">
                      <p>Top Video Comment Counts</p><h5>A bar chart showcasing the most popular videos and their comments counts</h5>
                      <div id="barChart" class="chart" style="box-shadow: none;"></div>

                    </div>
                    <div class="chart">
                      <p>Tags WordCloud</p> <h5>A visual snapshot of trending terms from video content, guiding your focus to prevalent topics</h5>
                      <div id="wordcloud0" class="wordcloud" style="box-shadow: none;"></div>

                    </div>
                  <div class="chart">
                    <p>Keyword Frequency</p><h5>The top 10 keywords in the videos titles and descriptions</h5>  
                    <div id="frequencyBarChart" class="chart" style="box-shadow: none;"></div>
                  </div>
  
                  <div class="chart" style="box-shadow: none; width: 100%;">
                    <p>Topic Views Over Publication time </p>
                    <h5>A line chart tracking video uploads dates and their corresponding total views, revealing patterns and interest in the topic over this year.</h5>
                  </div>
                  <div id="lineChart" class="chart" style="box-shadow: none;"></div>
  
                  </div>
                </div>
                
            </div>
        </div>

        

        <div id="popup1" class="overlay">
            <div class="popup">
                <h2>Are you sure you want to quit the analysis?</h2>
                <div class="text">
                    if you did you will not be able to access its content anymore...
                    <div class="popup-buttons">
                        <a href="{% url 'base' %}"><button class="yes">Yes I'm sure</button></a>
                    <a href="#"><button>Go back</button></a>
                    </div>   
                </div>
                
            </div>
        </div>



    </div>

   
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    AOS.init({
      // settings
    });
  });

  
</script>
<script id="json-data" type="application/json">{{ json_data|safe }}</script>



<script type="text/javascript">
  const csrftoken = '{{ csrf_token }}';
</script>


<script>
  function deepCopy(obj, visited = new WeakMap()) {
      if (obj === null || typeof obj !== 'object') {
          return obj;
      }
      if (visited.has(obj)) {
          return visited.get(obj);
      }
      let copy;
      if (Array.isArray(obj)) {
          copy = [];
          visited.set(obj, copy);
          obj.forEach((item, index) => {
              copy[index] = deepCopy(item, visited);
          });
          return copy;
      }
      if (obj instanceof Object) {
          copy = {};
          visited.set(obj, copy);
          Object.keys(obj).forEach(key => {
              // Skip properties that cause circular references
              if (key !== 'ctx') {
                  copy[key] = deepCopy(obj[key], visited);
              }
          });
          return copy;
      }
      throw new Error('Unable to copy object!');
  }
</script>

<script>
    document.getElementById('download-dataset-button').addEventListener('click', function() {
        window.location.href = "{% url 'topic_dataset_zipped_output' %}";
    });
</script>
<script>

    var jsonData = JSON.parse(document.getElementById('json-data').textContent);
    console.log('hi')
    console.log(jsonData.top_5_videos)
    console.log(jsonData.keybert_keywords)
    keybertKeywords = jsonData.keybert_keywords
    var videosNames = jsonData.top_5_videos.map(video => video.title);
    var trimmedNames = videosNames.map(label => 
    label.length > 15 ? label.substring(0, 5) + '...' : label);
    var video_comments = jsonData.top_5_videos.map(video => parseFloat(video["commentCount"]));
    var videoTitles = jsonData.videos_dict.map(video => video.title);
    var tags_list = [];
jsonData.top_5_videos.forEach(video => {
    tags_list = tags_list.concat(video.unique_tags);
});
     var options = {
  series: [{
    name: 'Comment count',
    data: video_comments
  }],
  chart: {
    type: 'bar',
    height: 350,
    background: 'transparent'
  },
  plotOptions: {
    bar: {
      horizontal: false,
      columnWidth: '55%',
      endingShape: 'rounded'
    },
  },
  tooltip: {
    x: {
        formatter: function(value, { series, seriesIndex, dataPointIndex, w }) {
            // Display the full channel name in the tooltip
            return videosNames[dataPointIndex]
        }
    }
},
  dataLabels: {
    enabled: false
  },
  xaxis: {
    categories: trimmedNames,
  },
  
        dataLabels: {
            enabled: false
        },
    
        grid: {
            show: false
        },
        legend: {
            show: false
        },
        theme: {
            mode: 'dark'
        },
        
        fill: {
            colors: ['#00E396', '#775DD0', '#775DD0', '#775DD0', '#775DD0'],
            type: 'gradient',
            gradient: {
                shade: 'light',
                type: "vertical",
                shadeIntensity: 0.5,
                gradientToColors: undefined, 
                inverseColors: true,
                opacityFrom: 0.85,
                opacityTo: 0.85,
                stops: [0, 100]
            }
        }

    ,
};

var chart = new ApexCharts(document.querySelector("#barChart"), options);
chart.render();
setTimeout(() => {
  chart.updateOptions({
  });

}, 1000);
var comment_barchart = deepCopy(chart.w.config);
comment_barchart.chart.foreColor = '#000'; // Set text color to black
comment_barchart.chart.background = '#FFF'; // Set background to white for contrast
comment_barchart.chart.height = 300; // Set text color to black
comment_barchart.chart.width = 300; // Set background to white for contrast
comment_barchart.title.text = "Top Video Comment Counts";
comment_barchart.xaxis.categories = videosNames
comment_barchart.xaxis.labels = {show: false}
comment_barchart.legend.show = true
comment_barchart.fill = {}

var channelNames = jsonData.channels_dict.map(channel => channel.Name);
var viewAverages = jsonData.channels_dict.map(channel => parseFloat(channel["TotalViews"]));

var options = {
  series: viewAverages,
  chart: {
    width: 380,
    type: 'pie',
    background: 'transparent'
  },
  toolbar: {
    show: true, // Show the toolbar
    tools: {
        download: true, // Enable the download tool
        selection: false,
    zoom: false,
    zoomin: false,
    zoomout: false,
    pan: false,
    reset: false
    }        },
series: viewAverages,
labels: channelNames,
theme: {
    mode: 'dark'
},

legend: {
    position: 'bottom'
},
stroke: {
    show: false, // No border
},
fill: {
    type: 'gradient',
    gradient: {
        shade: 'light',
        shadeIntensity: 0.05,
        inverseColors: true,
        opacityFrom: 0.85,
        opacityTo: 0.85,
        stops: [0, 100],
    }},
    dataLabels: {
        enabled: true,
        formatter: function (val) {
            return Math.round(val) + '%'; // Round to nearest integer
        },
        style: {
            fontSize: '14px',
            fontFamily: 'Raleway',
            fontWeight: 'bold',
            
        },
        dropShadow: {
            enabled: false  // Disable drop shadow on data labels
        }
    }
};

var chart = new ApexCharts(document.querySelector("#pieChart"), options);
chart.render();
setTimeout(() => {
  chart.updateOptions({
  });

}, 1000);
var channels_piechart = deepCopy(chart.w.config);
channels_piechart.chart.foreColor = '#000'; // Set text color to black
channels_piechart.chart.background = '#FFF'; // Set background to white for contrast
channels_piechart.chart.height = 300; // Set text color to black
channels_piechart.chart.width = 300; // Set background to white for contrast
channels_piechart.title.text = "Top topic channels views piechart";
channels_piechart.xaxis.categories = channelNames
channels_piechart.legend.show = true
channels_piechart.fill = {}

var words = keybertKeywords.map(keyword => keyword[0]);
var frequencies = keybertKeywords.map(keyword => keyword[1]);

var options = {
  series: [{
    name: 'Word Frequency',
    data: frequencies
  }],
  chart: {
    type: 'bar',
    height: 350,
    background: 'transparent'
  },
  plotOptions: {
    bar: {
      horizontal: true,
    },
  },
  theme: {
    mode: 'dark'
},
  dataLabels: {
    enabled: false
  },
  grid: {
            show: false
        },
        
  xaxis: {
    categories: words,
  }
};

var chart = new ApexCharts(document.querySelector("#frequencyBarChart"), options);
chart.render();
setTimeout(() => {
  chart.updateOptions({
  });

}, 1000);
var freq_barchart = deepCopy(chart.w.config);
freq_barchart.chart.foreColor = '#000'; // Set text color to black
freq_barchart.chart.background = '#FFF'; // Set background to white for contrast
freq_barchart.chart.height = 300; // Set text color to black
freq_barchart.chart.width = 300; // Set background to white for contrast
freq_barchart.title.text = "Topic words frequency";
freq_barchart.legend.show = true
freq_barchart.fill = {}
//////

    var videos = jsonData.videos_dict
    console.log(videos[0])

    // Initialize a map to hold month and total views count
    var viewsCountByMonth = {};

    // Define an array for month names
    var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    // Process each video to sum views by month
    videos.forEach(video => {
        var monthIndex = new Date(video.publishedAt).getMonth(); // getMonth() returns a zero-based index
        var monthName = monthNames[monthIndex];
        viewsCountByMonth[monthName] = (viewsCountByMonth[monthName] || 0) + video.viewsCount;
    });

    // Get the corresponding total views for each month
    var viewsCounts = monthNames.map(monthName => viewsCountByMonth[monthName] || 0);


  // Define the options for the line chart
  var lineChartOptions = {
    series: [{
      name: "Total Views",
      data: viewsCounts
    }],
    chart: {
      type: 'line',
      height: 350,
      background: 'transparent'
    },
    stroke: {
      width: 5,
      curve: 'smooth'
    },
    xaxis: {
      type: 'Month',
      categories: monthNames
    },
    
    fill: {
      type: 'gradient',
      gradient: {
        shade: 'dark',
        gradientToColors: [ '#FDD835'],
        shadeIntensity: 1,
        type: 'horizontal',
        opacityFrom: 1,
        opacityTo: 1,
        stops: [0, 100]
      },
    },
    
    markers: {
      size: 4,
      colors: ["#FFA41B"],
      strokeColors: "#fff",
      strokeWidth: 2,
      hover: {
        size: 7,
      }
    },
    grid: {
            show: false
        },
        theme: {
            mode: 'dark'
        },
  
  };

  // Render the line chart
  var lineChart = new ApexCharts(document.querySelector("#lineChart"), lineChartOptions);
  lineChart.render();
  setTimeout(() => {
    lineChart.updateOptions({
    });
  
  }, 1000);
  var trend_chart = deepCopy(lineChart.w.config);
  trend_chart.chart.foreColor = '#000'; // Set text color to black
  trend_chart.chart.background = '#FFF'; // Set background to white for contrast
  trend_chart.chart.height = 300; // Set text color to black
  trend_chart.chart.width = 500; // Set background to white for contrast
  trend_chart.title.text = "Videos Views over their publsihing Date";
  trend_chart.legend.show = true
  trend_chart.fill = {}
  ////
  var radialOptions = {
    series: [75], // Replace 75 with your actual percentage value
    chart: {
      height: 350,
      type: 'radialBar',
    },
    plotOptions: {
      radialBar: {
        hollow: {
          size: '70%',
        },
        dataLabels: {
          name: {
            show: false,
          },
          value: {
            formatter: function (val) {
              return parseInt(val) + "%";
            },
            color: 'white',
            fontSize: '36px',
            show: true,
          }
        }
      }
    },
    labels: ['Positive Comments'],
    colors: ['#20E647'], // Color for the radial bar
    stroke: {
      lineCap: 'round',
    },
    fill: {
      type: 'gradient',
      gradient: {
        shade: 'light',
        type: 'horizontal',
        shadeIntensity: 0.5,
        gradientToColors: ['#87D4F9'],
        inverseColors: true,
        opacityFrom: 1,
        opacityTo: 1,
        stops: [0, 100],
      },
    },
  };

</script>

<script>
    // Define a function to draw a word cloud
    var myColors = ['#D5A9FF', '#7EF7D9', '#12CEE6', '#4686FF', '#FFFFFF', /* more colors */ ];

    function drawWordCloud(selector, words) {
        // Create a function to generate random sizes for the words
        var getRandomSize = function() {
            return 10 + Math.random() * 10; // Random size between 10 and 50
        };
    
        // Set up the word cloud layout
        var layout = d3.layout.cloud()
            .size([400, 300]) // The size of the word cloud
            .words(words.map(function(d) {
                return {text: d, size: getRandomSize()}; // Assign random size to each word
            }))
            .padding(2) // Adjust padding between words
            .rotate(0) // Set rotation, if desired
            .font("Raleway")
            .fontSize(function(d) { return d.size; }) // Use the assigned size
            .on("end", draw);
    
        layout.start();
    
        // Draw the word cloud
        function draw(words) {
            var svg = d3.select(selector).append("svg")
                .attr("width", layout.size()[0])
                .attr("height", layout.size()[1])
                .append("g")
                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")");
    
            svg.selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function(d) { return d.size + "px"; }) // Font size is set by the layout
                .style("font-family", "Raleway")
                .style("font-weight", "bold") // Set the font family
                .style("fill", function(d, i) { return myColors[i % myColors.length]; }) // Set the color
                .attr("text-anchor", "middle")
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
        }
    }
    

// Define your array of words for each channel
//var channelsTags = jsonData.topTags
var channelsTags = [tags_list]

// Call the drawWordCloud function for each channel
channelsTags.forEach(function(tags, i) {
    drawWordCloud("#wordcloud" + (i), tags);
});

</script>




<script>$(document).ready(function(){
    $(".owl-carousel").owlCarousel({
        // Owl Carousel options
        items: 1,
        center: true,
        loop: true,
        autoplay: true,
        autoplayTimeout: 3000,
        autoplayHoverPause: true,
        nav: true
        // other options as needed
    });
});


</script>

    <script>
        AOS.init({
          duration: 1200, // You can adjust this value for animation duration
        });
      </script>


      <script>
        // Function to handle the rendering and conversion of a single chart to a data URI
    // Function to handle the rendering and conversion of a single chart to a data URI
    function convertChartToDataURI(chartOptions, callback) {
        console.log('hi');
        let exportContainer = document.createElement('div');
        exportContainer.style.position = 'absolute';
        exportContainer.style.left = '-9999px';
        exportContainer.style.top = '-9999px';
        document.body.appendChild(exportContainer);
    
        let modifiedChartOptions = {
            ...chartOptions,
            chart: {
                ...chartOptions.chart,
                events: {
                    rendered: function(chartContext, config) {
                        console.log('rendered');
                    }
                }
            }
        };
    
        let exportChart = new ApexCharts(exportContainer, modifiedChartOptions);
        exportChart.render();
    
        // Manually trigger the rendered event for testing
        setTimeout(() => {
            exportChart.dataURI().then(({ imgURI }) => {
                console.log('Manual trigger');
                exportChart.destroy();
                document.body.removeChild(exportContainer);
                callback(null, imgURI);
            });
        }, 1000); // Adjust this delay as needed
    }
    
    
    
    // Function to process all charts and send them to the server
    function processAndSendCharts(chartsOptions) {
        let chartImagesPromises = chartsOptions.map((options) => {
            return new Promise((resolve, reject) => {
                convertChartToDataURI(options, (error, imgURI) => {
                    if (error) {
                        reject(error);
                    } else {
                        resolve(imgURI);
                    }
                });
            });
        });
    
        Promise.all(chartImagesPromises).then((imagesURI) => {
            // Now you have all the images URI, send them to the server
            fetch('/doc_topic/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ imgData: imagesURI })
            }).then(response => response.json())
            .then(data => {
                console.log(data); // Handle any response from the server
            }).catch(error => {
                console.error('Error sending charts to the server:', error);
            });
        }).catch(error => {
            console.error('Error converting charts to images:', error);
        });
    }
    
    // Assuming you have an array of chart options for each chart
    let chartsOptions = [comment_barchart, channels_piechart, freq_barchart, trend_chart];
    
    // Process and send all charts
    processAndSendCharts(chartsOptions);
    
    </script>
  </body>
</html>
